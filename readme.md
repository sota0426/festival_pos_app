# 文化祭レジアプリ 要件定義書（確定版）

## 📱 システム概要

### アーキテクチャ
- **フロントエンド**: React Native (Expo)
- **バックエンド**: **Supabase** を推奨
  - 理由: 無料枠で月50,000行まで挿入可能、リアルタイム同期、認証機能標準装備
  - PostgreSQLベース、オフライン対応しやすい
- **デプロイ**: タブレットブラウザ + PWA化でオフライン対応

### データ同期戦略
- **オンライン時**: リアルタイム同期
- **オフライン時**: ローカルストレージに保存 → 1時間ごとに自動同期
- **本部集計**: 1時間ごとに全店舗データを集計

---

## 🏗️ 機能要件詳細

### 1. 本部システム

#### 1.1 認証・ログイン
- 本部管理者用ログイン画面
- 認証後、管理ダッシュボードへ

#### 1.2 支店管理
- **支店番号自動発行機能**
  - 新規模擬店登録時に自動採番（例: S001, S002...）
  - 支店番号 + 模擬店名 を保存
- **支店情報一覧**
  - 支店番号、模擬店名、登録日時、ステータス（稼働中/停止中）

#### 1.3 データ集計機能
**集計項目**
- 全体売上合計
- 支店別売上
- メニュー別売上
- 支払い方法別売上（PayPay / 金券）
- 時間帯別売上（1時間単位）
- 取引件数
- 平均客単価
- 売上目標達成率（支店別・全体）

**表示形式**
- ダッシュボード（グラフ + 数値）
- CSV/Excelエクスポート機能（任意）

#### 1.4 売上目標設定
- 全体目標金額設定
- 支店別目標金額設定
- 達成率リアルタイム表示

---

### 2. 模擬店システム

#### 2.1 初期設定
- 支店番号入力画面（本部から発行された番号を入力）
- 初回のみ、模擬店名を登録
- 以降は支店番号でログイン（簡易認証）

#### 2.2 メニュー登録画面
**登録項目**
- メニュー名（必須）
- 金額（必須）
- 在庫管理フラグ（ON/OFF）
  - ON: 残数を管理する
  - OFF: 残数無制限（在庫を気にしない）
- 残数（在庫管理ONの場合のみ）

**機能**
- メニュー追加/編集/削除
- 在庫数の手動変更（+/- ボタン or 直接入力）
- 在庫0の場合、レジ画面でグレーアウト表示

#### 2.3 レジ画面

**レイアウト**
```
┌─────────────────────────────────────┐
│  [左側: メニュー一覧]  │ [右側: 注文内容] │
│  ┌──────────┐      │  ┌──────────┐ │
│  │ 焼きそば │      │  │ 焼きそば  │ │
│  │  300円   │      │  │  ×2  600円│ │
│  └──────────┘      │  │          │ │
│  ┌──────────┐      │  │ たこ焼き  │ │
│  │ たこ焼き │      │  │  ×1  250円│ │
│  │  250円   │      │  └──────────┘ │
│  │ (残5)    │      │                │
│  └──────────┘      │  合計: 850円   │
│                     │                │
│                     │ [PayPay] [金券]│
│                     │ [キャンセル]   │
└─────────────────────────────────────┘
```

**機能**
- 左側: 登録メニューをタップで注文追加
  - 在庫管理ONで残数0 → グレーアウト + タップ不可
  - 在庫管理OFF → 常に選択可能
- 右側: 注文内容表示
  - 個別商品削除（×ボタン）
  - 数量変更（+/- ボタン）
  - 合計金額表示
- **支払いボタン**
  - PayPay支払い完了
  - 金券支払い完了
  - → 在庫自動減算 + 販売履歴保存 + ローカル保存
- **注文キャンセルボタン**
  - 注文内容をクリア

#### 2.4 販売履歴画面

**表示項目**
- 取引番号（自動採番）
- 日時（YYYY-MM-DD HH:MM）
- メニュー名（複数の場合は改行表示）
- 金額
- 支払い方法（PayPay / 金券）
- ステータス（完了 / 取消済）

**機能**
- 履歴一覧表示（新しい順）
- **注文取消機能**
  - 取消ボタン → 確認ダイアログ → 在庫を戻す + ステータス更新
  - 取消済みの取引はグレー表示

---

## 📊 データベース設計（Supabase想定）

### テーブル構成

#### `branches` (支店マスタ)
```sql
- id (UUID, PK)
- branch_code (TEXT, UNIQUE) // S001, S002...
- branch_name (TEXT)
- sales_target (INTEGER) // 目標金額
- status (TEXT) // active/inactive
- created_at (TIMESTAMP)
```

#### `menus` (メニューマスタ)
```sql
- id (UUID, PK)
- branch_id (UUID, FK)
- menu_name (TEXT)
- price (INTEGER)
- stock_management (BOOLEAN) // 在庫管理ON/OFF
- stock_quantity (INTEGER) // 残数
- is_active (BOOLEAN)
- is_show (BOOLEAN)
- created_at (TIMESTAMP)
- updated_at (TIMESTAMP)
```

#### `transactions` (取引履歴)
```sql
- id (UUID, PK)
- branch_id (UUID, FK)
- transaction_code (TEXT) // 取引番号
- total_amount (INTEGER)
- payment_method (TEXT) // paypay/voucher
- status (TEXT) // completed/cancelled
- created_at (TIMESTAMP)
- cancelled_at (TIMESTAMP)
```

#### `transaction_items` (取引明細)
```sql
- id (UUID, PK)
- transaction_id (UUID, FK)
- menu_id (UUID, FK)
- menu_name (TEXT) // スナップショット
- quantity (INTEGER)
- unit_price (INTEGER)
- subtotal (INTEGER)
```

---

## 🔄 オフライン対応設計

### ローカルストレージ戦略
```javascript
// IndexedDB または AsyncStorage使用
LocalStorage {
  - pending_transactions[] // 未同期の取引
  - menus[] // メニューキャッシュ
  - last_sync_time // 最終同期時刻
}
```

### 同期フロー
1. **オフライン時**
   - 取引データをローカルに保存
   - UIは通常通り動作
   
2. **1時間ごと or オンライン復帰時**
   - `pending_transactions`をSupabaseに一括送信
   - 成功したらローカルから削除
   - 在庫数をサーバーと同期

3. **競合解決**
   - 在庫数はサーバー値を優先
   - 取引データは追記のみ（削除しない）

---

## 🎨 UI/UX設計

### 画面遷移図
```
本部
└─ ログイン
   └─ ダッシュボード
      ├─ 支店管理
      ├─ 売上集計
      └─ 目標設定

模擬店
└─ 支店番号入力
   └─ メインメニュー
      ├─ メニュー登録
      ├─ レジ画面
      └─ 販売履歴
```

### カラースキーム（提案）
- プライマリ: 学校カラーに合わせる
- レジ画面: 明るく視認性重視
- 在庫警告: オレンジ（残り少ない）、グレー（在庫切れ）

---

## 🚀 開発フェーズ提案

### Phase 1: MVP（最小機能）
- [ ] Supabase環境構築
- [ ] 本部: ログイン + 支店登録
- [ ] 模擬店: メニュー登録
- [ ] 模擬店: レジ画面（基本機能）
- [ ] オンライン時のデータ保存

### Phase 2: コア機能
- [ ] 販売履歴 + 取消機能
- [ ] 在庫管理（自動減算 + 手動変更）
- [ ] オフライン対応 + 同期処理

### Phase 3: 拡張機能
- [ ] 本部集計ダッシュボード
- [ ] 売上目標 + 達成率表示
- [ ] PayPay / 金券の支払い区別

### Phase 4: 最適化
- [ ] PWA化（オフライン動作改善）
- [ ] パフォーマンス最適化
- [ ] エラーハンドリング強化

---

## 📋 補足情報

### 開発環境
- Node.js 18以上
- Expo SDK 50以上
- React Native 0.76以上

### 推奨ツール
- VSCode + React Native Tools拡張
- Expo Go (テスト用)
- Supabase CLI

### セキュリティ考慮事項
- 本部ログインは必ず強力なパスワードを使用
- 本番環境ではRow Level Security (RLS) を有効化
- API Keyは環境変数で管理（.envファイルは.gitignoreに追加）

---

**作成日**: 2026年2月4日  
**バージョン**: 1.0.0  
**最終更新**: 2026年2月4日